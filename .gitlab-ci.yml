stages:
  - ai

variables:
  GIT_STRATEGY: fetch
  GIT_DEPTH: 0

claude-review-mr:
  stage: ai
  image: node:24-alpine3.21
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web"'
      when: manual
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
      allow_failure: true
  before_script:
    - apk update && apk add --no-cache git curl bash openssh-client
    - npm install -g @anthropic-ai/claude-code
    - git config --global user.email "claude@ci.local"
    - git config --global user.name "Claude Code"
  script:
    - |
      PROMPT="${CLAUDE_PROMPT:-Review this code and suggest improvements. Focus on:
      - Security vulnerabilities
      - Performance issues
      - Code quality and best practices
      - Missing error handling}"

      claude -p "$PROMPT" \
        --permission-mode acceptEdits \
        --allowedTools "Read(*) Edit(*) Write(*) Grep(*) Glob(*) Bash(git diff*) Bash(git log*) Bash(git status)" \
        --max-turns 15
  timeout: 15m

claude-implement-issue:
  stage: ai
  image: node:24-alpine3.21
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $ISSUE_IID'
      when: manual
  before_script:
    - apk update && apk add --no-cache git curl bash openssh-client jq
    - npm install -g @anthropic-ai/claude-code
    - git config --global user.email "claude@ci.local"
    - git config --global user.name "Claude Code"
  script:
    - |
      ISSUE_DATA=$(curl -s --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/issues/$ISSUE_IID")

      ISSUE_TITLE=$(echo "$ISSUE_DATA" | jq -r '.title')
      ISSUE_DESC=$(echo "$ISSUE_DATA" | jq -r '.description')

      BRANCH_NAME="claude/issue-${ISSUE_IID}-$(date +%s)"
      git checkout -b "$BRANCH_NAME"

      PROMPT="Implement the following GitLab issue:

      Title: $ISSUE_TITLE

      Description:
      $ISSUE_DESC

      Instructions:
      1. Analyze the codebase to understand the architecture
      2. Implement the requested feature/fix
      3. Follow existing code patterns and conventions
      4. Add appropriate error handling
      5. Stage your changes with git add"

      claude -p "$PROMPT" \
        --permission-mode acceptEdits \
        --allowedTools "Read(*) Edit(*) Write(*) Grep(*) Glob(*) Bash(git add*) Bash(git diff*) Bash(git status)" \
        --max-turns 25

      if ! git diff --cached --quiet; then
        git commit -m "feat: implement issue #${ISSUE_IID} - ${ISSUE_TITLE}

      Closes #${ISSUE_IID}

      Co-Authored-By: Claude Code <noreply@anthropic.com>"

        git push -o ci.skip "https://oauth2:${GITLAB_TOKEN}@gitlab.com/${CI_PROJECT_PATH}.git" "$BRANCH_NAME"

        echo "Branch pushed: $BRANCH_NAME"
        echo "Create MR at: https://gitlab.com/${CI_PROJECT_PATH}/-/merge_requests/new?merge_request[source_branch]=$BRANCH_NAME"
      else
        echo "No changes were made"
      fi
  timeout: 20m
