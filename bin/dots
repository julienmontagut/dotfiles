#!/bin/bash

XDG_DATA_HOME=${XDG_DATA_HOME:-$HOME/.local/share}
DOTFILES_DIR="${XDG_DATA_HOME:-$HOME/.local/share}/dotfiles"

usage() {
    echo "Usage: $0 subcommand"
    echo "Manage dot files easily"
    echo ""
    echo "Subcommands:"
    echo "  edit    Edit the dotfiles and sync them"
    echo "  help    Show this help message"
    echo "  pull    Pull dotfiles changes from the remote"
    echo "  push    Push dotfiles changes to the remote"
    echo "  sync    Sync dotfiles with the remote"
    echo ""
}

apply() {
    # Auto-detect platform
    case "$(uname -s)" in
        Linux*)  platform="linux" ;;
        Darwin*) platform="macos" ;;
        *)       echo "Unsupported platform: $(uname -s)"; exit 1 ;;
    esac

    # Use --impure flag if overrides.nix exists and is not tracked by git
    local impure_flag=""
    if [ -f "$DOTFILES_DIR/overrides.nix" ] && ! git -C "$DOTFILES_DIR" ls-files --error-unmatch overrides.nix >/dev/null 2>&1; then
        impure_flag="--impure"
    fi

    home-manager switch --flake "$DOTFILES_DIR#$platform" $impure_flag
}

pull() {
    cd "$DOTFILES_DIR" || exit 1
    git pull --rebase
    apply
}

push() {
    cd "$DOTFILES_DIR" || exit 1
    git add -A
    git commit -m "Update dotfiles"
    git push
}

sync() {
    pull
    push
}

edit() {
    pull
    EDITOR="${EDITOR:-vim}"
    $EDITOR "$DOTFILES_DIR"
    apply
    if [ $? -eq 0 ]; then
        readline -p "Apply changes successful. Push to remote? (y/n): " choice
        if [[ "$choice" == "y" || "$choice" == "Y" ]]; then
            push
        fi
    else
        echo "Error applying changes. Not pushing to remote."
    fi
}

status() {
    cd "$DOTFILES_DIR" || exit 1
    git status
}

if [ $# -eq 0 ]; then
    usage
    exit 1
fi

case $1 in
    edit)
        edit
        ;;
    help)
        usage
        ;;
    pull)
        pull
        ;;
    push)
        push
        ;;
    sync)
        sync
        ;;
    *)
        echo "Unknown subcommand: $1"
        usage
        exit 1
        ;;
esac
