#!/bin/bash

XDG_DATA_HOME=${XDG_DATA_HOME:-$HOME/.local/share}
DOTFILES_DIR="${XDG_DATA_HOME}/dotfiles"

usage() {
    echo "Usage: dots <command>"
    echo ""
    echo "Commands:"
    echo "  edit     Open editor, apply, optionally push"
    echo "  apply    Apply dotfiles configuration"
    echo "  pull     Pull from remote and apply"
    echo "  push     Commit and push to remote"
    echo "  sync     Pull then push"
    echo "  status   Show git status"
    echo ""
}

apply() {
    case "$(uname -s)" in
        Linux*)  platform="linux" ;;
        Darwin*) platform="macos" ;;
        *)       echo "Unsupported platform: $(uname -s)"; exit 1 ;;
    esac

    local impure_flag=""
    if [ -f "$DOTFILES_DIR/overrides.nix" ] && ! git -C "$DOTFILES_DIR" ls-files --error-unmatch overrides.nix >/dev/null 2>&1; then
        impure_flag="--impure"
    fi

    home-manager switch --flake "$DOTFILES_DIR#$platform" $impure_flag
}

pull() {
    git -C "$DOTFILES_DIR" pull --rebase
    apply
}

push() {
    git -C "$DOTFILES_DIR" add -A
    git -C "$DOTFILES_DIR" commit -m "Update dotfiles"
    git -C "$DOTFILES_DIR" push
}

sync() {
    git -C "$DOTFILES_DIR" pull --rebase
    push
}

status() {
    git -C "$DOTFILES_DIR" status
}

edit() {
    ${EDITOR:-vim} "$DOTFILES_DIR"
    apply || return 1
    read -p "Push changes? (y/n): " choice
    [[ "$choice" == [yY] ]] && push
}

if [ $# -eq 0 ]; then
    usage
    exit 1
fi

case $1 in
    edit)   edit ;;
    apply)  apply ;;
    pull)   pull ;;
    push)   push ;;
    sync)   sync ;;
    status) status ;;
    help|-h|--help) usage ;;
    *)      echo "Unknown command: $1"; usage; exit 1 ;;
esac
