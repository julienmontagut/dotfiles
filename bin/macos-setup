#!/bin/sh
set -e

# macOS Setup Script
# Replicates nix-darwin system configuration operations
# This script should be run manually after home-manager setup

echo "ðŸŽ Starting macOS system configuration..."

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running on macOS
if [ "$(uname)" != "Darwin" ]; then
  echo "${RED}Error: This script is only for macOS${NC}"
  exit 1
fi

# Function to check if running with sudo when needed
check_sudo() {
  if [ "$EUID" -ne 0 ]; then
    echo "${YELLOW}Some operations require sudo access${NC}"
    sudo -v
    # Keep sudo alive
    while true; do sudo -n true; sleep 60; kill -0 "$$" || exit; done 2>/dev/null &
  fi
}

echo "\n${GREEN}[1/6]${NC} Configuring Nix settings..."
# Configure Nix settings in user config (avoids needing sudo for /etc/nix/nix.conf)
mkdir -p ~/.config/nix
cat > ~/.config/nix/nix.conf <<EOF
experimental-features = nix-command flakes
auto-optimise-store = true
EOF
echo "âœ“ Nix settings configured"

echo "\n${GREEN}[2/6]${NC} Configuring macOS system defaults..."

# Menu bar clock - 24 hour format
defaults write com.apple.menuextra.clock Show24Hour -bool true

# Trackpad settings
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad Clicking -bool true
defaults write com.apple.AppleMultitouchTrackpad Clicking -bool true
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadRightClick -bool true
defaults write com.apple.AppleMultitouchTrackpad TrackpadRightClick -bool true
defaults write com.apple.driver.AppleBluetoothMultitouch.trackpad TrackpadThreeFingerDrag -bool true
defaults write com.apple.AppleMultitouchTrackpad TrackpadThreeFingerDrag -bool true

# Keyboard - Remap Caps Lock to Control
# Note: This requires manual configuration in System Preferences > Keyboard > Modifier Keys
echo "  ${YELLOW}âš  Manual action required:${NC}"
echo "    Go to System Settings > Keyboard > Keyboard Shortcuts > Modifier Keys"
echo "    and set Caps Lock to Control"

echo "âœ“ System defaults configured"

echo "\n${GREEN}[3/6]${NC} Configuring TouchID for sudo..."
# Enable TouchID for sudo
check_sudo
if [ ! -f /etc/pam.d/sudo_local ]; then
  sudo sh -c 'echo "# sudo_local: local config file which survives system update and is included for sudo" > /etc/pam.d/sudo_local'
  sudo sh -c 'echo "# uncomment following line to enable Touch ID for sudo" >> /etc/pam.d/sudo_local'
  sudo sh -c 'echo "auth       sufficient     pam_tid.so" >> /etc/pam.d/sudo_local'
  echo "âœ“ TouchID for sudo enabled"
else
  if ! grep -q "pam_tid.so" /etc/pam.d/sudo_local; then
    sudo sh -c 'echo "auth       sufficient     pam_tid.so" >> /etc/pam.d/sudo_local'
    echo "âœ“ TouchID for sudo enabled"
  else
    echo "âœ“ TouchID for sudo already configured"
  fi
fi

echo "\n${GREEN}[4/6]${NC} Configuring environment variables..."
# Add Homebrew environment variables to shell profile
if ! grep -q "HOMEBREW_NO_ANALYTICS" ~/.zshrc 2>/dev/null; then
  cat >> ~/.zshrc <<'EOF'

# Homebrew settings
export HOMEBREW_NO_ANALYTICS=1
export HOMEBREW_NO_ENV_HINTS=1
EOF
  echo "âœ“ Homebrew environment variables added to ~/.zshrc"
else
  echo "âœ“ Homebrew environment variables already configured"
fi

echo "\n${GREEN}[5/6]${NC} Checking Homebrew installation..."
if ! command -v brew >/dev/null 2>&1; then
  echo "${YELLOW}Homebrew not found. Installing...${NC}"
  /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"
  eval "$(/opt/homebrew/bin/brew shellenv)"
else
  echo "âœ“ Homebrew is installed"
fi

echo "\n${GREEN}[6/6]${NC} Installing Homebrew packages from Brewfile..."
# Find the dotfiles directory (where this script lives)
SCRIPT_DIR="$(cd "$(dirname "$0")/.." && pwd)"
BREWFILE="$SCRIPT_DIR/Brewfile"

if [ ! -f "$BREWFILE" ]; then
  echo "${RED}Error: Brewfile not found at $BREWFILE${NC}"
  exit 1
fi

echo "  Using Brewfile: $BREWFILE"
cd "$SCRIPT_DIR"
brew bundle --file="$BREWFILE" || echo "  ${YELLOW}âš  Some packages failed to install${NC}"
echo "âœ“ Homebrew packages installed"

# Check if netbird is needed
echo "\n${YELLOW}Optional: Netbird VPN${NC}"
echo "  To install Netbird VPN, run: brew install --cask netbird-ui"

echo "\n${GREEN}âœ… macOS setup complete!${NC}"
echo "\n${YELLOW}Post-setup actions:${NC}"
echo "  1. Restart your Mac to apply all system settings"
echo "  2. Manually set Caps Lock â†’ Control in System Settings"
echo "  3. Run 'brew cleanup' to remove old versions"
echo "  4. Configure Netbird VPN if needed"
echo "\n${YELLOW}Maintenance commands:${NC}"
echo "  â€¢ Update Homebrew: brew update && brew upgrade"
echo "  â€¢ Clean Homebrew: brew cleanup"
echo "  â€¢ Nix garbage collection: nix-collect-garbage -d"
echo "  â€¢ Optimize Nix store: nix-store --optimise"
