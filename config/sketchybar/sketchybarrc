#!/usr/bin/env bash

BG=0xff24283b
BLACK=0xff000000
FG=0xffc0caf5
BLUE=0xff7aa2f7
CYAN=0xff7dcfff
GREEN=0xff9ece6a
YELLOW=0xffe0af68
RED=0xfff7768e
MAGENTA=0xffbb9af7
GRAY=0xff565f89

FONT="Lilex Nerd Font Mono"

CURRENT_DIR=$(dirname "$0")

# Detect the main display. If it is the built-in one

# Detect display characteristics
# Check if we're on a high-DPI external display (Studio Display is 5120x2880 or similar)
MAIN_DISPLAY_WIDTH=$(system_profiler SPDisplaysDataType | grep "Resolution" | head -1 | awk '{print $2}')

# Detect if internal display has notch (MacBook Pro 14"/16" have notch, resolution width is 3024 or 3456)
INTERNAL_WIDTH=$(system_profiler SPDisplaysDataType | grep -A 20 "Built-In" | grep "Resolution" | awk '{print $2}')

# Set bar color (black for notch displays, Tokyo Night for others)
if [ "$INTERNAL_WIDTH" = "3024" ] || [ "$INTERNAL_WIDTH" = "3456" ] || [ "$INTERNAL_WIDTH" = "3456" ]; then
BAR_COLOR=$BLACK
else
BAR_COLOR=$BG
fi

# Bar settings
sketchybar --bar height=32 \
               blur_radius=30 \
               position=top \
               padding_left=20 \
               padding_right=20 \
               color=$BAR_COLOR \
               notch_offset=on

# Default settings
sketchybar --default updates=when_shown \
                   icon.font="$FONT:Regular:28.0" \
                   icon.color=$FG \
                   icon.padding_left=8 \
                   icon.padding_right=8 \
                   label.font="$FONT:Medium:15.0" \
                   label.color=$FG \
                   label.padding_left=8 \
                   label.padding_right=8 \
                   background.height=4 \
                   background.y_offset=-16 \
                   background.corner_radius=0 \
                   background.padding_left=4 \
                   background.padding_right=4 \

# Events
sketchybar --add event aerospace_workspace_change

# Workspace indicators (always show 1-4)
for sid in 1 2 3 4; do
sketchybar --add item space.$sid left \
           --subscribe space.$sid aerospace_workspace_change \
           --set space.$sid \
                 label="$sid" \
                 label.color=$FG \
                 icon.drawing=off \
                 click_script="aerospace workspace $sid && sleep 0.1 && sketchybar --trigger aerospace_workspace_change FOCUSED_WORKSPACE=$sid" \
                 script="$HOME/.config/sketchybar/plugins/aerospace.sh $sid"
done

# Right side items (added right to left)
sketchybar --add item date right \
         --set date update_freq=30 \
                    icon.drawing=off \
                    label.align=center \
                    background.color=$MAGENTA \
                    script="$HOME/.config/sketchybar/plugins/date.sh"

# Battery 
sketchybar --add item battery right \
           --set battery update_freq=60 \
                         script="$HOME/.config/sketchybar/plugins/battery.sh"

# RAM
sketchybar --add item ram right \
         --set ram update_freq=10 \
                   icon= \
                   script="$HOME/.config/sketchybar/plugins/ram.sh"

# CPU
sketchybar --add item cpu right \
         --set cpu update_freq=10 \
                   icon= \
                   script="$HOME/.config/sketchybar/plugins/cpu.sh"

# WiFi
sketchybar --add item wifi right \
         --set wifi update_freq=30 \
                    click_script="open /System/Library/PreferencePanes/Network.prefPane" \
                    script="$HOME/.config/sketchybar/plugins/wifi.sh"

sketchybar --add item network right \
         --set wifi update_freq=30 \
                    click_script="open /System/Library/PreferencePanes/Network.prefPane" \
                    script="$HOME/.config/sketchybar/plugins/network.sh"

sketchybar --update

INITIAL_WORKSPACE=$(aerospace list-workspaces --focused)
sketchybar --trigger aerospace_workspace_change FOCUSED_WORKSPACE="$INITIAL_WORKSPACE"
