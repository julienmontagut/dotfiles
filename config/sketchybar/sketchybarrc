#!/usr/bin/env bash

BG=0xff24283b
BLACK=0xff000000
FG=0xffc0caf5
BLUE=0xff7aa2f7
CYAN=0xff7dcfff
GREEN=0xff9ece6a
YELLOW=0xffe0af68
RED=0xfff7768e
MAGENTA=0xffbb9af7
GRAY=0xff565f89

FONT="Lilex Nerd Font Mono"

CURRENT_DIR=$(dirname "$0")

# Detect if the built-in display is the main display
# Extract the display info and check if Built-in section contains "Main Display: Yes"
DISPLAY_INFO=$(system_profiler SPDisplaysDataType)
if echo "$DISPLAY_INFO" | grep -A 20 "Display Type:.*Built-in" | grep -q "Main Display: Yes"; then
    MAIN_IS_BUILTIN="yes"
else
    MAIN_IS_BUILTIN="no"
fi

# Set bar color based on which display is main
if [ "$MAIN_IS_BUILTIN" = "yes" ]; then
    BAR_COLOR=$BLACK  # Built-in is main - use black (blends with notch)
else
    BAR_COLOR=$BG     # External is main - use Tokyo Night background
fi

# Bar settings
sketchybar --bar height=32 \
               blur_radius=30 \
               position=top \
               padding_left=20 \
               padding_right=20 \
               color=$BAR_COLOR \
               notch_offset=on

# Default settings
sketchybar --default updates=when_shown \
                   icon.font="$FONT:Regular:28.0" \
                   icon.color=$FG \
                   icon.padding_left=8 \
                   icon.padding_right=8 \
                   label.font="$FONT:Medium:15.0" \
                   label.color=$FG \
                   label.padding_left=8 \
                   label.padding_right=8 \
                   background.height=4 \
                   background.y_offset=-16 \
                   background.corner_radius=0 \
                   background.padding_left=4 \
                   background.padding_right=4 \

# Events
sketchybar --add event aerospace_workspace_change

# Workspace indicators (always show 1-4)
for sid in 1 2 3 4; do
sketchybar --add item space.$sid left \
           --subscribe space.$sid aerospace_workspace_change \
           --set space.$sid \
                 label="$sid" \
                 label.color=$FG \
                 icon.drawing=off \
                 click_script="aerospace workspace $sid && sleep 0.1 && sketchybar --trigger aerospace_workspace_change FOCUSED_WORKSPACE=$sid" \
                 script="$HOME/.config/sketchybar/plugins/aerospace.sh $sid"
done

# Right side items (added right to left)
sketchybar --add item date right \
         --set date update_freq=30 \
                    icon.drawing=off \
                    label.align=center \
                    background.color=$MAGENTA \
                    script="$HOME/.config/sketchybar/plugins/date.sh"

# Battery 
sketchybar --add item battery right \
           --set battery update_freq=60 \
                         script="$HOME/.config/sketchybar/plugins/battery.sh"

# RAM
sketchybar --add item ram right \
         --set ram update_freq=10 \
                   icon= \
                   script="$HOME/.config/sketchybar/plugins/ram.sh"

# CPU
sketchybar --add item cpu right \
         --set cpu update_freq=10 \
                   icon= \
                   script="$HOME/.config/sketchybar/plugins/cpu.sh"

# WiFi
sketchybar --add item wifi right \
         --set wifi update_freq=30 \
                    click_script="open /System/Library/PreferencePanes/Network.prefPane" \
                    script="$HOME/.config/sketchybar/plugins/wifi.sh"

sketchybar --add item network right \
         --set wifi update_freq=30 \
                    click_script="open /System/Library/PreferencePanes/Network.prefPane" \
                    script="$HOME/.config/sketchybar/plugins/network.sh"

sketchybar --update

INITIAL_WORKSPACE=$(aerospace list-workspaces --focused)
sketchybar --trigger aerospace_workspace_change FOCUSED_WORKSPACE="$INITIAL_WORKSPACE"
